@model BankIdDemoApp.ViewModels.BankIdAuthViewModel

@{
    ViewData["Title"] = "BankID Autentisering";
}

<div class="container d-flex justify-content-center align-items-center main-bankid" role="main">
    <div class="card">
        <div class="inner">
            <div class="info">
                <div class="info-header">
                    <img alt="BankID" class="info-icon-header" src="/images/logo/BankID_logo.svg">
                </div>
                <div class="info-content" tabindex="-1">
                    <h2 class="info-title">BankID Autentisering</h2>

                    @if (Model.LaunchingType == "BankIDQrCode" && !string.IsNullOrEmpty(Model.QrCodeBase64))
                    {
                        <p class="info-text">Starta BankID-appen på din mobila enhet och läs av QR-koden.</p>
                        <div id="qr-container">
                            <img id="qr-code" src="data:image/png;base64,@Model.QrCodeBase64" alt="BankID QR-kod" style="width: 200px; height: 200px;" />
                        </div>
                    }
                    else if (Model.LaunchingType == "BankIDAutostart" && !string.IsNullOrEmpty(Model.AutoStartToken))
                    {
                       <div class="spinner-container">
                            <svg class="spinner" viewBox="0 0 64 64">

                                <!-- gradienten -->
                                <defs>
                                    <linearGradient id="gradient" x1="0%" x2="100%">
                                        <stop offset="0%" class="stop1" />
                                        <stop offset="100%" class="stop2" />
                                    </linearGradient>
                                </defs>
                                <!-- Cirkel som ritas fram -->
                                <circle cx="32" cy="32" r="25"></circle>
                            </svg>
                        </div> 
                    }
                </div>

                <div id="collect-status" class="message-container" aria-live="polite"></div>

                <div class="actions">
                    <button class="btn btn-secondary" onclick="window.location.href='@Url.Action("Index", "Home")'">Avbryt</button>
                    @if (Model.LaunchingType == "BankIDAutostart" && !string.IsNullOrEmpty(Model.AutoStartToken))
                    {
                    <button class="btn btn-primary" onclick="autoStartBankId()">Öppna BankID-appen</button>                    
                    }
                  
                </div>
            </div>
        </div>
    </div>
</div>



<script>
    var autoStartToken = "@Model.AutoStartToken";
    var returnUrl = "@Model.ReturnUrl";
    var launchingType = "@Model.LaunchingType";
    var returnUrlNull = null;

    function updateQrCode() {
        fetch('@Url.Action("UpdateQrCode", "Auth")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.qrCodeBase64) {
                    document.getElementById('qr-code').src = `data:image/png;base64,${data.qrCodeBase64}`;
                }
            })
            .catch(error => console.error('Error updating QR code:', error));

        // Uppdatera QR-koden var 1000 ms (1 sekund).
        setTimeout(updateQrCode, 1000);
    }

    window.onload = function () {
        if (launchingType === "BankIDQrCode") {
            updateQrCode();
        } else if (launchingType === "BankIDAutostart" && autoStartToken) {
            autoStartBankId();
        }
        pollStatus();
    };

    function autoStartBankId() {
       

        if (navigator.userAgent.match(/(iPhone|iPad|iPod)/g )) {
            // iOS: Använd Universal Link
            var url = `https://app.bankid.com/?autostarttoken=${autoStartToken}&redirect=${encodeURIComponent(returnUrl)}`;
            window.location.href = url;
        } else if (navigator.userAgent.match(/(Android)/g)) {
            // Android: Försök att öppna BankID-appen med URL
            // Om browser är chrome så öppnas inte appen utan en länk till appen visas
            if (navigator.userAgent.match(/(Chrome)/g)) {
                document.getElementById('collect-status').innerHTML = "<div class='message-text alert alert-info'>Öppna BankID-appen manuellt och verifiera dig.</div>";
                window.location.href = `bankid:///?autostarttoken=${autoStartToken}&redirect=${encodeURIComponent(returnUrlNull)}`;

            }
            else {
                window.location.href = `bankid:///?autostarttoken=${autoStartToken}&redirect=${encodeURIComponent(returnUrlNull)}`;
            }


          
        } else {
            // För desktop-enheter
            window.location.href = `bankid:///?autostarttoken=${autoStartToken}&redirect=${encodeURIComponent(returnUrlNull)}`;
        }

    }

    function pollStatus() {
        fetch('@Url.Action("CollectStatus", "Auth")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })

            .then(response => response.json())
            .then(data => {
                const collectStatusElement = document.getElementById('collect-status');
                if (data.partialViewHtml) {
                    collectStatusElement.innerHTML = data.partialViewHtml;
                }

                if (data.status === "complete") {
                    collectStatusElement.innerHTML = "<div class='message-text alert alert-success'>Verifiering klar! Omdirigerar till Mina Sidor...</div>";
                    setTimeout(function () {
                        window.location.href = returnUrl;
                    }, 2000);
                } else if (data.status === "pending") {
                    setTimeout(pollStatus, 2000);
                }
            })
            .catch(error => {
                console.error('Error fetching status:', error);
                document.getElementById('collect-status').innerHTML = "<div class='message-text alert alert-danger'>Ett fel uppstod. Försök igen senare.</div>";
            });
    }
</script>
